{% extends "base.html" %}

{% block static_path %}../../{% endblock %}

{% block title %}{{ checker.name }} - Lean Kernel Arena{% endblock %}

{% block h1 %}<a href="../../">Lean Kernel Arena</a> / {{ checker.name }}
{% endblock %}

{% block style %}
.bg-success { background-color: #d4edda; }
.bg-error { background-color: #f8d7da; }
.bg-warning { background-color: #fff3cd; }
.link-group {
    margin-top: 0.5rem;
}
.link-group a {
    margin-right: 1rem;
    text-decoration: none;
    padding: 0.25rem 0.5rem;
    background-color: #e9ecef;
    border-radius: 3px;
    font-size: 0.9rem;
}
.link-group a:hover {
    background-color: #d3d8e0;
}
details summary {
    cursor: pointer;
    user-select: none;
    margin-bottom: 0.5rem;
}
section pre, details pre {
    background-color: #f5f5f5;
    padding: 0.5rem;
    border-radius: 4px;
    overflow-x: auto;
    max-height: 300px;
    overflow-y: auto;
}
.description {
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
    padding: 0.75rem;
    background-color: #f8f9fa;
    border-radius: 4px;
}
.description p {
    margin: 0 0 0.5rem 0;
}
.description p:last-child {
    margin-bottom: 0;
}
{% endblock %}

{% block content %}
<section>
    <header>
        <h2>Checker "{{ checker.name }}"</h2>
    </header>
    <p>
        {% if checker.version %}<strong>Version:</strong> {{ checker.version }}{% endif %}
        {% if checker.version and (checker_links.declaration_url or checker_links.source_url) %} Â· {% endif %}
        {% if checker_links.declaration_url %}
        <a href="{{ checker_links.declaration_url }}" target="_blank">ğŸ“„ Declaration</a>
        {% endif %}
        {% if checker_links.declaration_url and checker_links.source_url %} Â· {% endif %}
        {% if checker_links.source_url %}
        <a href="{{ checker_links.source_url }}" target="_blank">ğŸ”— Source</a>
        {% endif %}
    </p>

    {% if checker.description %}
    <div class="description">
        {{ checker.description | safe }}
    </div>
    {% endif %}

    <div class="row">
        <div class="col-4">
            <div class="card">
                <header>Completeness (rightfully accepted tests)</header>
                <p class="is-center" style="font-size: 2rem;">
                    {{ checker.stats.accept_correct }}/{{ checker.stats.accept_total }}
                </p>
            </div>
        </div>
        <div class="col-4">
            <div class="card">
                <header>Soundness (rightfully rejected tests)</header>
                <p class="is-center" style="font-size: 2rem;">
                    {{ checker.stats.reject_correct }}/{{ checker.stats.reject_total }}
                </p>
            </div>
        </div>
        <div class="col-4">
            <div class="card">
                <header>Declined tests</header>
                <p class="is-center" style="font-size: 2rem;">
                    {{ checker.stats.declined_count }}
                </p>
            </div>
        </div>
    </div>
    
    {% if results %}
    <div style="overflow-x:auto">
    <table class="striped">
        <thead>
            <tr>
                <th>Test</th>
                <th class="text-center">Expected</th>
                <th class="text-center">Result</th>
                <th class="text-right">Wall Time</th>
                <th class="text-right">CPU Time</th>
                <th class="text-right"></th>
                <th class="text-right">Max RSS</th>
                <th class="text-right"></th>
            </tr>
        </thead>
        <tbody>
            {% for result in results %}
            <tr>
                <td><a href="#test-{{ result.test }}">{{ result.test }}</a></td>
                <td class="text-center">
                    {% if result.expected == 'accept' %}âœ…{% elif result.expected == 'reject' %}âŒ{% else %}âš ï¸ {{ result.expected }}{% endif %}
                </td>
                <td class="text-center {% if (result.expected == 'accept' and result.status == 'accepted') or (result.expected == 'reject' and result.status == 'rejected') %}{% elif result.status == 'declined' %}bg-warning{% else %}bg-error{% endif %}">
                    {% if result.status == 'accepted' %}âœ…{% elif result.status == 'rejected' %}âŒ{% elif result.status == 'declined' %}ğŸš«{% else %}ğŸ’¥{% endif %}
                </td>
                <td class="text-right">{{ format_duration(result.wall_time or 0) }}</td>
                <td class="text-right">
                    {% if result.get('instructions', 0) > 0 and instructions_per_second > 0 %}
                        <span title="{{ format_instructions(result.get('instructions', 0)) }} instructions">{{ format_duration(convert_instructions_to_time(result.get('instructions', 0), instructions_per_second)) }}</span>
                    {% elif result.cpu_time is not none %}
                        {{ format_duration(result.cpu_time) }}
                    {% endif %}
                </td>
                <td class="text-right">
                    {# CPU Time comparison - only show if test expected to succeed, both succeeded, official took >=1s #}
                    {% if result.expected == 'accept' and result.status == 'accepted' and result.official and result.official.status == 'accepted' %}
                        {% set official_cpu_time = convert_instructions_to_time(result.official.get('instructions', 0), instructions_per_second) if result.official.get('instructions', 0) > 0 and instructions_per_second > 0 else result.official.cpu_time %}
                        {% set current_cpu_time = convert_instructions_to_time(result.get('instructions', 0), instructions_per_second) if result.get('instructions', 0) > 0 and instructions_per_second > 0 else result.cpu_time %}
                        {% if official_cpu_time and official_cpu_time >= 1.0 and current_cpu_time %}
                            {% set percent_change = ((current_cpu_time - official_cpu_time) / official_cpu_time * 100) | round(0) | int %}
                            {% if percent_change > 0 %}(+{{ percent_change }}%){% elif percent_change < 0 %}({{ percent_change }}%){% else %}(0%){% endif %}
                        {% else %}
                            -
                        {% endif %}
                    {% endif %}
                </td>
                <td class="text-right">
                    {% if result.max_rss is not none %}
                        {{ format_memory(result.max_rss) }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="text-right">
                    {# Memory comparison - only show if test expected to succeed, both succeeded, official used >=200MB #}
                    {% if result.expected == 'accept' and result.status == 'accepted' and result.official and result.official.status == 'accepted' %}
                        {% set official_memory = result.official.max_rss %}
                        {% set current_memory = result.max_rss %}
                        {% if official_memory and official_memory >= 200*1024*1024 and current_memory %}
                            {% set percent_change = ((current_memory - official_memory) / official_memory * 100) | round(0) | int %}
                            {% if percent_change > 0 %}(+{{ percent_change }}%){% elif percent_change < 0 %}({{ percent_change }}%){% else %}(0%){% endif %}
                        {% else %}
                            -
                        {% endif %}
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
</section>
<section>
  <header>
    <h2>Detailed results</h2>
  </header>

    {% for result in results %}
    <h3 id="test-{{ result.test }}">Test "{{ result.test }}"</h3>
    
    <p>
        <strong>Expected:</strong> 
        {% if result.expected == 'accept' %}âœ… accept{% elif result.expected == 'reject' %}âŒ reject{% else %}âš ï¸ {{ result.expected }}{% endif %}
        {% if result.test_stats %}
        Â· <strong>Size:</strong> {{ result.test_stats.size_str }}
        Â· <strong>Lines:</strong> {{ result.test_stats.lines_str }}
        {% endif %}
        {% if result.test_stats.lean4export_version %}
        Â· <strong>lean4export:</strong> {{ result.test_stats.lean4export_version }}
        {% endif %}
        {% if result.test_stats.lean_version %}
        Â· <strong>Lean:</strong> {{ result.test_stats.lean_version }}
        {% endif %}
        {% if result.test_links.declaration_url or result.test_links.source_url %} Â· {% endif %}
        {% if result.test_links.declaration_url %}
        <a href="{{ result.test_links.declaration_url }}" target="_blank">ğŸ“„ Declaration</a>
        {% endif %}
        {% if result.test_links.declaration_url and result.test_links.source_url %} Â· {% endif %}
        {% if result.test_links.source_url %}
        <a href="{{ result.test_links.source_url }}" target="_blank">ğŸ”— Source</a>
        {% endif %}
    </p>
    {% if result.test_description %}
    <div class="description">
        {{ result.test_description | safe }}
    </div>
    {% endif %}
    
    <p>
      <b>Test result:</b>
        <span class="{% if (result.expected == 'accept' and result.status == 'accepted') or (result.expected == 'reject' and result.status == 'rejected') %}bg-success{% elif (result.expected == 'accept' and result.status != 'accepted' and result.status != 'declined') or (result.expected == 'reject' and result.status != 'rejected' and result.status != 'declined') %}bg-error{% else %}bg-warning{% endif %}" style="padding: 0.2em 0.5em; border-radius: 3px;">
            {% if result.status == 'accepted' %}âœ… accepted{% elif result.status == 'rejected' %}âŒ rejected{% elif result.status == 'declined' %}ğŸš« declined{% else %}ğŸ’¥ {{ result.status }}{% endif %}
        </span>
        Â· exit code {{ result.exit_code }}
        Â· wall: {{ format_duration(result.wall_time or 0) }}
        {% if result.cpu_time is not none and result.cpu_time > 0 %}
        Â· real cpu: {{ format_duration(result.cpu_time) }}
        {% endif %}
        {% if result.get('instructions', 0) > 0 %}
        Â· inst: {{ format_instructions(result.get('instructions', 0)) }}
        {% endif %}
        {% if result.max_rss is not none %}
        Â· rss: {{ format_memory(result.max_rss) }}
        {% endif %}
    </p>
    {% if result.stdout %}
    <h5>stdout:</h5>
    <pre>{{ result.stdout }}</pre>
    {% endif %}
    {% if result.stderr %}
    <h5>stderr:</h5>
    <pre>{{ result.stderr }}</pre>
    {% endif %}
    {% endfor %}

    {% else %}
    <p class="text-grey">No test results available.</p>
    {% endif %}
</section>
{% endblock %}
